---
# yamllint disable rule:truthy
name: Push Personalities

on:
  push:
    tags:
      - "v*"

permissions:
  contents: read

env:
  REGISTRY: gsoci.azurecr.io
  REGISTRY_PATH: giantswarm/klaus-personalities

jobs:
  push:
    name: Push Personality OCI Artifacts
    runs-on: ubuntu-latest
    env:
      TAG: ${{ github.ref_name }}
      ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
      ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: Install ORAS
        uses: oras-project/setup-oras@v1

      - name: Login to registry
        run: |
          set -euo pipefail
          oras login "$REGISTRY" \
            --username "$ACR_USERNAME" \
            --password "$ACR_PASSWORD"

      - name: Push personalities
        run: |
          set -euo pipefail

          config_media_type="application/vnd.giantswarm.klaus-personality.config.v1+json"
          content_media_type="application/vnd.giantswarm.klaus-personality.content.v1.tar+gzip"

          for dir in personalities/*/; do
            name="$(basename "$dir")"
            ref="${REGISTRY}/${REGISTRY_PATH}/${name}:${TAG}"
            personality_spec="${dir}personality.yaml"
            description="$(awk -F': ' '/^description:/ {sub(/^description:[[:space:]]*/, "", $0); print; exit}' "$personality_spec")"

            echo "--- Packaging personality: ${name} ---"

            config_file="$(mktemp)"
            printf '{"name":"%s","version":"%s"}' "$name" "$TAG" > "$config_file"

            content_file="$(mktemp --suffix=.tar.gz)"
            tar -czf "$content_file" -C "$dir" .

            echo "Pushing ${ref}"
            oras push "$ref" \
              --disable-path-validation \
              --annotation "io.giantswarm.klaus.type=personality" \
              --annotation "io.giantswarm.klaus.name=${name}" \
              --annotation "io.giantswarm.klaus.version=${TAG}" \
              --annotation "org.opencontainers.image.title=${name}" \
              --annotation "org.opencontainers.image.version=${TAG}" \
              --annotation "org.opencontainers.image.description=${description}" \
              --config "$config_file:${config_media_type}" \
              "$content_file:${content_media_type}"

            rm -f "$config_file" "$content_file"
            echo "Pushed ${ref}"
          done
