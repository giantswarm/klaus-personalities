---
# yamllint disable rule:truthy
name: Auto Release
on:
  pull_request:
    types: [closed]
    branches:
      - main

permissions:
  contents: write  # Needed to create releases and tags
  pull-requests: read  # Needed to read PR information

concurrency:
  group: auto-release-main
  cancel-in-progress: false

jobs:
  auto_release:
    name: Auto Release
    if: github.event.pull_request.merged
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          # Fetch all history and tags for version calculation
          fetch-depth: 0

      - name: Configure Git
        env:
          GIT_ACTOR: ${{ github.actor }}
        run: |
          git config user.name "$GIT_ACTOR"
          git config user.email "${GIT_ACTOR}@users.noreply.github.com"

      - name: Create and push next tag
        id: tag
        run: |
          set -euo pipefail

          get_latest_tag() {
            git tag --list 'v[0-9]*.[0-9]*.[0-9]*' --sort=-v:refname | sed -n '1p'
          }

          for attempt in 1 2 3 4 5; do
            latest_tag="$(get_latest_tag)"

            if [[ -z "$latest_tag" ]]; then
              latest_tag="v0.0.0"
            fi

            if [[ ! "$latest_tag" =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
              echo "Invalid semver tag discovered: ${latest_tag}"
              exit 1
            fi

            major="${BASH_REMATCH[1]}"
            minor="${BASH_REMATCH[2]}"
            patch="${BASH_REMATCH[3]}"
            next_patch=$((patch + 1))
            next_version="v${major}.${minor}.${next_patch}"

            echo "Attempt ${attempt}: latest=${latest_tag}, next=${next_version}"

            if git rev-parse "$next_version" >/dev/null 2>&1; then
              echo "Tag ${next_version} already exists locally, retrying."
              continue
            fi

            git tag "$next_version"
            if git push origin "$next_version"; then
              echo "tag=${next_version}" >> "$GITHUB_OUTPUT"
              exit 0
            fi

            # Another workflow likely won the race; remove local tag and retry.
            git tag -d "$next_version" >/dev/null 2>&1 || true
            sleep 2
          done

          echo "Failed to create and push a unique release tag after retries."
          exit 1

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.tag.outputs.tag }}
        run: |
          set -euo pipefail
          gh release create "$TAG" \
            --title "Release $TAG" \
            --generate-notes \
            --verify-tag

  push_personalities:
    name: Push Personality OCI Artifacts
    needs: auto_release
    uses: ./.github/workflows/push-personalities.yaml
    with:
      tag: ${{ needs.auto_release.outputs.tag }}
    secrets: inherit
